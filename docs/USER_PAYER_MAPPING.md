# ãƒ¦ãƒ¼ã‚¶ãƒ¼ã”ã¨ã®Payerè¨­å®š

Discord Botã§ã¯ã€ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ä¿¡ã—ãŸãƒ¦ãƒ¼ã‚¶ãƒ¼ã«å¿œã˜ã¦ã€Difyãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã«æ¸¡ã™`payer`ã®å€¤ã‚’è‡ªå‹•çš„ã«åˆ‡ã‚Šæ›¿ãˆã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

## ğŸ” ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã®ç¢ºèªæ–¹æ³•

### 1. Discordã§è‡ªåˆ†ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã‚’ç¢ºèª

Discordãƒãƒ£ãƒ³ãƒãƒ«ã§ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„ï¼š

```
!whoami
```

ä»¥ä¸‹ã®ã‚ˆã†ãªæƒ…å ±ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ï¼š

```
ğŸ‘¤ ã‚ãªãŸã®æƒ…å ±
ãƒ¦ãƒ¼ã‚¶ãƒ¼ID: 123456789012345678
ãƒ¦ãƒ¼ã‚¶ãƒ¼å: hoshi
è¡¨ç¤ºå: æ˜Ÿ å¤ªéƒ

ğŸ’¡ ã“ã®æƒ…å ±ã‚’ä½¿ã£ã¦Payerã‚’è¨­å®šã§ãã¾ã™ï¼
```

### 2. åˆ¥ã®æ–¹æ³•: Discordé–‹ç™ºè€…ãƒ¢ãƒ¼ãƒ‰

1. Discordè¨­å®š â†’ è©³ç´°è¨­å®š â†’ é–‹ç™ºè€…ãƒ¢ãƒ¼ãƒ‰ã‚’æœ‰åŠ¹åŒ–
2. ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’å³ã‚¯ãƒªãƒƒã‚¯ â†’ ã€ŒIDã‚’ã‚³ãƒ”ãƒ¼ã€

## âš™ï¸ Payerè¨­å®šã®ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚º

### main.goã®ç·¨é›†

`main.go`ã®`getPayerFromDiscordUser`é–¢æ•°ã‚’ç·¨é›†ã—ã¦ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¨Payerã®ãƒãƒƒãƒ”ãƒ³ã‚°ã‚’è¨­å®šã—ã¾ã™ã€‚

#### è¨­å®šå ´æ‰€

```go
// Discordãƒ¦ãƒ¼ã‚¶ãƒ¼IDã¾ãŸã¯ãƒ¦ãƒ¼ã‚¶ãƒ¼åã‹ã‚‰payerã‚’åˆ¤å®šã™ã‚‹é–¢æ•°
func getPayerFromDiscordUser(userID, username string) string {
	log.Printf("  ğŸ‘¤ [Payer] ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±: ID=%s, Username=%s", userID, username)

	// ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã§åˆ¤å®šï¼ˆå„ªå…ˆï¼‰
	switch userID {
	case "123456789012345678": // ä¾‹: ãƒ¦ãƒ¼ã‚¶ãƒ¼Aã®ID
		log.Printf("  âœ… [Payer] ãƒ¦ãƒ¼ã‚¶ãƒ¼ID %s ã‚’æ¤œå‡º -> Payer: S", userID)
		return "S"
	case "987654321098765432": // ä¾‹: ãƒ¦ãƒ¼ã‚¶ãƒ¼Bã®ID
		log.Printf("  âœ… [Payer] ãƒ¦ãƒ¼ã‚¶ãƒ¼ID %s ã‚’æ¤œå‡º -> Payer: T", userID)
		return "T"
	case "111222333444555666": // ä¾‹: ãƒ¦ãƒ¼ã‚¶ãƒ¼Cã®ID
		log.Printf("  âœ… [Payer] ãƒ¦ãƒ¼ã‚¶ãƒ¼ID %s ã‚’æ¤œå‡º -> Payer: U", userID)
		return "U"
	}

	// ãƒ¦ãƒ¼ã‚¶ãƒ¼åã§åˆ¤å®šï¼ˆãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼‰
	switch username {
	case "hoshi":
		log.Printf("  âœ… [Payer] Username %s ã‚’æ¤œå‡º -> Payer: S", username)
		return "S"
	case "alice":
		log.Printf("  âœ… [Payer] Username %s ã‚’æ¤œå‡º -> Payer: T", username)
		return "T"
	case "bob":
		log.Printf("  âœ… [Payer] Username %s ã‚’æ¤œå‡º -> Payer: U", username)
		return "U"
	}

	// ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤
	log.Printf("  âš ï¸  [Payer] æœªç™»éŒ²ãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼ˆID: %s, Username: %sï¼‰ -> ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆPayer: S", userID, username)
	return "S"
}
```

### è¨­å®šä¾‹

#### ä¾‹1: ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã§åˆ¤å®šï¼ˆæ¨å¥¨ï¼‰

```go
switch userID {
case "234567890123456789": // å¤ªéƒã•ã‚“
	return "S"
case "345678901234567890": // èŠ±å­ã•ã‚“
	return "T"
case "456789012345678901": // æ¬¡éƒã•ã‚“
	return "U"
}
```

**ãƒ¡ãƒªãƒƒãƒˆ**:
- ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã¯å¤‰æ›´ã•ã‚Œãªã„ï¼ˆæ°¸ç¶šçš„ï¼‰
- ç¢ºå®Ÿãªè­˜åˆ¥ãŒå¯èƒ½

#### ä¾‹2: ãƒ¦ãƒ¼ã‚¶ãƒ¼åã§åˆ¤å®š

```go
switch username {
case "taro":
	return "S"
case "hanako":
	return "T"
case "jiro":
	return "U"
}
```

**ãƒ‡ãƒ¡ãƒªãƒƒãƒˆ**:
- ãƒ¦ãƒ¼ã‚¶ãƒ¼åã¯å¤‰æ›´å¯èƒ½ï¼ˆéæ¨å¥¨ï¼‰
- ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ã¨ã—ã¦ä½¿ç”¨

#### ä¾‹3: è¤‡é›‘ãªæ¡ä»¶

```go
// ç‰¹å®šã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚°ãƒ«ãƒ¼ãƒ—
adminUsers := []string{"123456789012345678", "234567890123456789"}
for _, adminID := range adminUsers {
	if userID == adminID {
		return "ADMIN"
	}
}

// é€šå¸¸ãƒ¦ãƒ¼ã‚¶ãƒ¼
switch userID {
case "345678901234567890":
	return "S"
default:
	return "GUEST"
}
```

## ğŸ§ª ãƒ†ã‚¹ãƒˆæ–¹æ³•

### 1. ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’ç¢ºèª

```
!whoami
```

### 2. ç”»åƒã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰

```
!upload
```
ï¼ˆç”»åƒã‚’æ·»ä»˜ï¼‰

### 3. ãƒ­ã‚°ã‚’ç¢ºèª

ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ã§ä»¥ä¸‹ã®ã‚ˆã†ãªãƒ­ã‚°ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ï¼š

```log
ğŸ‘¤ [Payer] ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±: ID=123456789012345678, Username=hoshi
âœ… [Payer] ãƒ¦ãƒ¼ã‚¶ãƒ¼ID 123456789012345678 ã‚’æ¤œå‡º -> Payer: S
ğŸ’³ [Dify Workflow] æ±ºå®šã•ã‚ŒãŸPayer: S
ğŸ“‹ [Dify Workflow] inputsæ§‹é€ :
  - receipt_images: é…åˆ—ï¼ˆè¦ç´ æ•°: 1ï¼‰
  - transfer_method: local_file
  - upload_file_id: xxx
  - type: image
  - payer: S (ãƒ¦ãƒ¼ã‚¶ãƒ¼: hoshi)
```

## ğŸ“ ã‚ˆãã‚ã‚‹è³ªå•

### Q1: ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã¨ãƒ¦ãƒ¼ã‚¶ãƒ¼åã€ã©ã¡ã‚‰ã‚’ä½¿ã†ã¹ãï¼Ÿ

**A**: ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã‚’æ¨å¥¨ã—ã¾ã™ã€‚ç†ç”±ï¼š
- ãƒ¦ãƒ¼ã‚¶ãƒ¼åã¯å¤‰æ›´å¯èƒ½
- ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã¯ä¸å¤‰ã§ç¢ºå®Ÿ

### Q2: æœªç™»éŒ²ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯ã©ã†ãªã‚‹ï¼Ÿ

**A**: ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ï¼ˆ"S"ï¼‰ãŒè¨­å®šã•ã‚Œã¾ã™ã€‚å¿…è¦ã«å¿œã˜ã¦å¤‰æ›´ã—ã¦ãã ã•ã„ã€‚

```go
// ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã‚’å¤‰æ›´
return "GUEST" // ã¾ãŸã¯ "UNKNOWN" ãªã©
```

### Q3: è¤‡æ•°äººã§åŒã˜Payerã‚’ä½¿ã„ãŸã„

**A**: é…åˆ—ã§ç®¡ç†ã™ã‚‹ã‹ã€é–¢æ•°ã‚’æ‹¡å¼µã—ã¦ãã ã•ã„ã€‚

```go
// ãƒãƒ¼ãƒ ã”ã¨ã«ã‚°ãƒ«ãƒ¼ãƒ”ãƒ³ã‚°
teamS := []string{"123456789012345678", "234567890123456789"}
teamT := []string{"345678901234567890", "456789012345678901"}

for _, id := range teamS {
	if userID == id {
		return "S"
	}
}
for _, id := range teamT {
	if userID == id {
		return "T"
	}
}
```

### Q4: è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã§ç®¡ç†ã—ãŸã„

**A**: ç’°å¢ƒå¤‰æ•°ã‚„å¤–éƒ¨JSONãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½¿ã†æ–¹æ³•ã‚‚ã‚ã‚Šã¾ã™ã€‚

#### ç’°å¢ƒå¤‰æ•°ã®ä¾‹

`.env`ã«è¿½åŠ ï¼š
```env
USER_PAYER_MAP=123456789012345678:S,234567890123456789:T,345678901234567890:U
```

`main.go`ã§èª­ã¿è¾¼ã¿ï¼š
```go
func getPayerFromDiscordUser(userID, username string) string {
	mappingStr := os.Getenv("USER_PAYER_MAP")
	if mappingStr != "" {
		pairs := strings.Split(mappingStr, ",")
		for _, pair := range pairs {
			parts := strings.Split(pair, ":")
			if len(parts) == 2 && parts[0] == userID {
				return parts[1]
			}
		}
	}
	return "S" // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ
}
```

#### JSONãƒ•ã‚¡ã‚¤ãƒ«ã®ä¾‹

`user_mapping.json`:
```json
{
  "123456789012345678": "S",
  "234567890123456789": "T",
  "345678901234567890": "U"
}
```

èª­ã¿è¾¼ã¿ã‚³ãƒ¼ãƒ‰ï¼ˆè¦å®Ÿè£…ï¼‰ï¼š
```go
func loadUserMapping() map[string]string {
	// JSONãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã‚“ã§ãƒãƒƒãƒ—ã‚’è¿”ã™
}
```

## ğŸ”’ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£æ³¨æ„äº‹é …

1. **ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã¯æ©Ÿå¯†æƒ…å ±**: Gitã«ã‚³ãƒŸãƒƒãƒˆã™ã‚‹å ´åˆã¯æ³¨æ„
2. **ç’°å¢ƒå¤‰æ•°ã‚’ä½¿ç”¨**: æœ¬ç•ªç’°å¢ƒã§ã¯è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã‚’å¤–éƒ¨åŒ–
3. **ãƒ­ã‚°ã«æ³¨æ„**: å¿…è¦ã«å¿œã˜ã¦ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’ãƒã‚¹ã‚¯

## ğŸš€ æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—

1. `!whoami`ã‚³ãƒãƒ³ãƒ‰ã§å…¨å“¡ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã‚’åé›†
2. `getPayerFromDiscordUser`é–¢æ•°ã‚’ç·¨é›†
3. Botã‚’å†èµ·å‹•ï¼ˆ`go run main.go`ï¼‰
4. `!upload`ã§ãƒ†ã‚¹ãƒˆ
5. ãƒ­ã‚°ã§PayerãŒæ­£ã—ãè¨­å®šã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª

## ğŸ“Š ãƒ­ã‚°å‡ºåŠ›ä¾‹

### æ­£å¸¸ãªå ´åˆ

```log
ğŸ“· [STEP 1/8] onMessageCreate: ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å—ä¿¡ - Content: !upload, Author: hoshi
ğŸ‘¤ [Dify Workflow] å®Ÿè¡Œãƒ¦ãƒ¼ã‚¶ãƒ¼: ID=123456789012345678, Username=hoshi
ğŸ‘¤ [Payer] ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±: ID=123456789012345678, Username=hoshi
âœ… [Payer] ãƒ¦ãƒ¼ã‚¶ãƒ¼ID 123456789012345678 ã‚’æ¤œå‡º -> Payer: S
ğŸ’³ [Dify Workflow] æ±ºå®šã•ã‚ŒãŸPayer: S
```

### æœªç™»éŒ²ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å ´åˆ

```log
ğŸ“· [STEP 1/8] onMessageCreate: ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å—ä¿¡ - Content: !upload, Author: unknown_user
ğŸ‘¤ [Dify Workflow] å®Ÿè¡Œãƒ¦ãƒ¼ã‚¶ãƒ¼: ID=999888777666555444, Username=unknown_user
ğŸ‘¤ [Payer] ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±: ID=999888777666555444, Username=unknown_user
âš ï¸  [Payer] æœªç™»éŒ²ãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼ˆID: 999888777666555444, Username: unknown_userï¼‰ -> ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆPayer: S
ğŸ’³ [Dify Workflow] æ±ºå®šã•ã‚ŒãŸPayer: S
```
