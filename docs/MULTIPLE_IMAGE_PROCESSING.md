# 複数画像処理機能

## 📋 機能概要

Discord Botが複数の画像が添付されたメッセージに対応し、全ての画像を順次処理してDify AIで解析する機能です。

## 🔧 実装内容

### 主要な改善点

#### 1. **複数画像対応**
- 従来: 最初の添付ファイルのみ処理
- 改善後: 全ての添付ファイルを順次処理

#### 2. **進捗表示**
- 各画像の処理状況をリアルタイムで表示
- `[1/3] image1.jpg を処理中...` 形式で進捗を表示

#### 3. **エラーハンドリング**
- 一部の画像が失敗しても、残りの画像処理を継続
- 個別の成功/失敗をログ記録

#### 4. **サマリー表示**
- 全ての処理完了後に結果のサマリーを表示
- 成功/失敗の件数を集計

#### 5. **負荷軽減**
- 画像間の処理に2秒間隔を設定
- Discord API、Dify APIのレート制限を回避

## 📊 処理フロー

```
複数画像添付
↓
🖼️ N個の画像を処理中です...
↓
[1/N] image1.jpg を処理中...
├─ ダウンロード → 圧縮 → Dify処理
├─ ✅ [1/N] image1.jpg: Dify処理が完了しました！
├─ ⏱️ 次の画像処理まで2秒待機...
↓
[2/N] image2.jpg を処理中...
├─ ダウンロード → 圧縮 → Dify処理
├─ ✅ [2/N] image2.jpg: Dify処理が完了しました！
↓
...
↓
🎉 全ての画像処理が完了しました！
✅ 成功: N個
❌ 失敗: 0個
```

## 🎯 使用例

### 単一画像の場合
```
ユーザー: [image1.jpg添付]
Bot: 🖼️ 1個の画像を処理中です...
Bot: 📷 [1/1] image1.jpg を処理中...
Bot: ✅ [1/1] image1.jpg: Dify処理が完了しました！
     {処理結果JSON}
Bot: 🎉 全ての画像処理が完了しました！
     ✅ 成功: 1個
     ❌ 失敗: 0個
```

### 複数画像の場合
```
ユーザー: [receipt1.jpg, receipt2.jpg, receipt3.jpg添付]
Bot: 🖼️ 3個の画像を処理中です...
Bot: 📷 [1/3] receipt1.jpg を処理中...
Bot: ✅ [1/3] receipt1.jpg: Dify処理が完了しました！
     {処理結果JSON}
Bot: 📷 [2/3] receipt2.jpg を処理中...
Bot: ✅ [2/3] receipt2.jpg: Dify処理が完了しました！
     {処理結果JSON}
Bot: 📷 [3/3] receipt3.jpg を処理中...
Bot: ✅ [3/3] receipt3.jpg: Dify処理が完了しました！
     {処理結果JSON}
Bot: 🎉 全ての画像処理が完了しました！
     ✅ 成功: 3個
     ❌ 失敗: 0個
```

### エラーが含まれる場合
```
ユーザー: [valid.jpg, corrupted.jpg, valid2.jpg添付]
Bot: 🖼️ 3個の画像を処理中です...
Bot: 📷 [1/3] valid.jpg を処理中...
Bot: ✅ [1/3] valid.jpg: Dify処理が完了しました！
Bot: 📷 [2/3] corrupted.jpg を処理中...
Bot: ❌ [2/3] corrupted.jpg の圧縮に失敗しました: エラー詳細
Bot: 📷 [3/3] valid2.jpg を処理中...
Bot: ✅ [3/3] valid2.jpg: Dify処理が完了しました！
Bot: ⚠️ 一部の画像処理が完了しました。
     ✅ 成功: 2個
     ❌ 失敗: 1個
```

## ⚙️ 設定とパフォーマンス

### 処理間隔設定
```go
// 画像間の待機時間（現在: 2秒）
time.Sleep(2 * time.Second)
```

### 推奨使用制限
- **最大画像数**: 10個程度（Discord API制限）
- **ファイルサイズ**: 1画像あたり8MB以下
- **処理時間**: 1画像あたり10-30秒程度

### パフォーマンス指標
- **処理速度**: 約30秒/画像（Dify API依存）
- **メモリ使用量**: 画像数に比例（一時的）
- **エラー率**: < 5%（ネットワーク状況による）

## 🔍 ログ出力例

```
📷 画像アップロード処理開始 - User: hoshi, 画像数: 3
📎 [1/3] 処理中: receipt1.jpg
✅ 画像圧縮完了: 45.2% 削減
✅ ワークフロー実行成功
✅ [1/3] 画像処理が完了しました: receipt1.jpg
⏱️ 次の画像処理まで2秒待機...
📎 [2/3] 処理中: receipt2.jpg
✅ 画像圧縮完了: 38.1% 削減
✅ ワークフロー実行成功
✅ [2/3] 画像処理が完了しました: receipt2.jpg
⏱️ 次の画像処理まで2秒待機...
📎 [3/3] 処理中: receipt3.jpg
✅ 画像圧縮完了: 42.7% 削減
✅ ワークフロー実行成功
✅ [3/3] 画像処理が完了しました: receipt3.jpg
📊 画像処理サマリー - 成功: 3, 失敗: 0, 合計: 3
```

## 🚀 今後の拡張可能性

### 並列処理対応
- 現在: 順次処理
- 改善案: 並列処理（要Dify API制限考慮）

### バッチ処理
- 複数画像を一括でDifyに送信
- ワークフロー側での複数画像対応

### プログレスバー
- Discord内でのプログレス表示
- より詳細な進捗状況

---

**最終更新**: 2025年11月5日  
**対応バージョン**: Go 1.24.5